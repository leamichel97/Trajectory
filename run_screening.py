# -*- coding: utf-8 -*-
"""
  run_screening.py generated by WhatsOpt 1.9.1
"""
# DO NOT EDIT unless you know what you are doing
# analysis_id: 735

import sys
import numpy as np
import matplotlib.pyplot as plt
from packaging import version

from openmdao import __version__ as OPENMDAO_VERSION
from openmdao.api import Problem, SqliteRecorder, CaseReader
from openmdao_extensions.salib_doe_driver import SalibDOEDriver

from SALib.analyze import morris
from SALib.analyze import sobol
from SALib.plotting import morris as mp
from SALib.plotting.bar import plot as barplot
from trajectoire import Trajectoire 


from optparse import OptionParser
parser = OptionParser()
parser.add_option("-b", "--batch",
                  action="store_true", dest="batch", default=False,
                  help="do not plot anything")
parser.add_option("-s", "--sobol",
                  action="store_true", dest="sobol", default=False,
                  help="do not plot anything")
parser.add_option("-p", "--parallel", 
                  action="store_true", default=False,
                  help="run doe in parallel")
(options, args) = parser.parse_args()

pb = Problem(Trajectoire())
sa_method_name='Morris'
sa_doe_options={'n_trajs': 10, 'n_levels': 4}
if options.sobol:
    sa_method_name='Sobol'
    sa_doe_options={'n_samples': 500, 'calc_second_order': False}

pb.driver = SalibDOEDriver(sa_method_name=sa_method_name, sa_doe_options=sa_doe_options)
pb.driver.options['run_parallel'] = options.parallel

case_recorder_filename = 'trajectoire_screening.sqlite'        
recorder = SqliteRecorder(case_recorder_filename)
pb.driver.add_recorder(recorder)

if version.parse(OPENMDAO_VERSION) > version.parse("2.8.0"):
    pb.model.nonlinear_solver.options['err_on_non_converge'] = True
else:
    pb.model.nonlinear_solver.options['err_on_maxiter'] = True


pb.model.add_design_var('alpha', lower=-sys.float_info.max, upper=sys.float_info.max)
pb.model.add_design_var('DeltaV', lower=-sys.float_info.max, upper=sys.float_info.max)
pb.model.add_design_var('gamma', lower=-sys.float_info.max, upper=sys.float_info.max)
pb.model.add_design_var('mu', lower=-sys.float_info.max, upper=sys.float_info.max)
pb.model.add_design_var('r_M', lower=-sys.float_info.max, upper=sys.float_info.max)
pb.model.add_design_var('V1', lower=-sys.float_info.max, upper=sys.float_info.max)


pb.model.add_objective('a2')
pb.model.add_objective('e')
pb.model.add_objective('h')
pb.model.add_objective('p')
pb.model.add_objective('ra')
pb.model.add_objective('rp')
pb.model.add_objective('V2')

pb.setup()  
pb.run_driver()        


if options.batch  or options.parallel:
    exit(0)
reader = CaseReader(case_recorder_filename)
cases = reader.list_cases('driver', recurse=False)
n = len(cases)
data = {'inputs': {}, 'outputs': {} }
data['inputs']['alpha'] = np.zeros((n,)+(1,))
data['inputs']['DeltaV'] = np.zeros((n,)+(1,))
data['inputs']['gamma'] = np.zeros((n,)+(1,))
data['inputs']['mu'] = np.zeros((n,)+(1,))
data['inputs']['r_M'] = np.zeros((n,)+(1,))
data['inputs']['V1'] = np.zeros((n,)+(1,))
data['outputs']['a2'] = np.zeros((n,)+(1,))
data['outputs']['e'] = np.zeros((n,)+(1,))
data['outputs']['h'] = np.zeros((n,)+(1,))
data['outputs']['p'] = np.zeros((n,)+(1,))
data['outputs']['ra'] = np.zeros((n,)+(1,))
data['outputs']['rp'] = np.zeros((n,)+(1,))
data['outputs']['V2'] = np.zeros((n,)+(1,))

for i in range(len(cases)):
    case = reader.get_case(cases[i])
    data['inputs']['alpha'][i,:] = case.outputs['alpha']
    data['inputs']['DeltaV'][i,:] = case.outputs['DeltaV']
    data['inputs']['gamma'][i,:] = case.outputs['gamma']
    data['inputs']['mu'][i,:] = case.outputs['mu']
    data['inputs']['r_M'][i,:] = case.outputs['r_M']
    data['inputs']['V1'][i,:] = case.outputs['V1']
    data['outputs']['a2'][i,:] = case.outputs['a2']
    data['outputs']['e'][i,:] = case.outputs['e']
    data['outputs']['h'][i,:] = case.outputs['h']
    data['outputs']['p'][i,:] = case.outputs['p']
    data['outputs']['ra'][i,:] = case.outputs['ra']
    data['outputs']['rp'][i,:] = case.outputs['rp']
    data['outputs']['V2'][i,:] = case.outputs['V2']

salib_pb = pb.driver.get_salib_problem()
inputs = pb.driver.get_cases()

print('')
print('*** Output: a2')
output = data['outputs']['a2'].reshape((-1,))

if options.sobol:  
    Si = sobol.analyze(salib_pb, output, 
                       calc_second_order=sa_doe_options['calc_second_order'], 
                       print_to_console=True)
    Si_df = Si.to_df()
    fig, axes = plt.subplots(1, len(Si_df))
    for idx, f in enumerate(Si_df):
        axes[idx] = barplot(f, ax=axes[idx])
    fig.suptitle('a2 '+'sensitivity')

else:
    Si = morris.analyze(salib_pb, inputs, output, print_to_console=True)

    fig, (ax1, ax2) = plt.subplots(1,2)
    fig.suptitle('a2 '+'sensitivity')

    mp.horizontal_bar_plot(ax1, Si, {})
    mp.covariance_plot(ax2, Si, {})

print('')
print('*** Output: e')
output = data['outputs']['e'].reshape((-1,))

if options.sobol:  
    Si = sobol.analyze(salib_pb, output, 
                       calc_second_order=sa_doe_options['calc_second_order'], 
                       print_to_console=True)
    Si_df = Si.to_df()
    fig, axes = plt.subplots(1, len(Si_df))
    for idx, f in enumerate(Si_df):
        axes[idx] = barplot(f, ax=axes[idx])
    fig.suptitle('e '+'sensitivity')

else:
    Si = morris.analyze(salib_pb, inputs, output, print_to_console=True)

    fig, (ax1, ax2) = plt.subplots(1,2)
    fig.suptitle('e '+'sensitivity')

    mp.horizontal_bar_plot(ax1, Si, {})
    mp.covariance_plot(ax2, Si, {})

print('')
print('*** Output: h')
output = data['outputs']['h'].reshape((-1,))

if options.sobol:  
    Si = sobol.analyze(salib_pb, output, 
                       calc_second_order=sa_doe_options['calc_second_order'], 
                       print_to_console=True)
    Si_df = Si.to_df()
    fig, axes = plt.subplots(1, len(Si_df))
    for idx, f in enumerate(Si_df):
        axes[idx] = barplot(f, ax=axes[idx])
    fig.suptitle('h '+'sensitivity')

else:
    Si = morris.analyze(salib_pb, inputs, output, print_to_console=True)

    fig, (ax1, ax2) = plt.subplots(1,2)
    fig.suptitle('h '+'sensitivity')

    mp.horizontal_bar_plot(ax1, Si, {})
    mp.covariance_plot(ax2, Si, {})

print('')
print('*** Output: p')
output = data['outputs']['p'].reshape((-1,))

if options.sobol:  
    Si = sobol.analyze(salib_pb, output, 
                       calc_second_order=sa_doe_options['calc_second_order'], 
                       print_to_console=True)
    Si_df = Si.to_df()
    fig, axes = plt.subplots(1, len(Si_df))
    for idx, f in enumerate(Si_df):
        axes[idx] = barplot(f, ax=axes[idx])
    fig.suptitle('p '+'sensitivity')

else:
    Si = morris.analyze(salib_pb, inputs, output, print_to_console=True)

    fig, (ax1, ax2) = plt.subplots(1,2)
    fig.suptitle('p '+'sensitivity')

    mp.horizontal_bar_plot(ax1, Si, {})
    mp.covariance_plot(ax2, Si, {})

print('')
print('*** Output: ra')
output = data['outputs']['ra'].reshape((-1,))

if options.sobol:  
    Si = sobol.analyze(salib_pb, output, 
                       calc_second_order=sa_doe_options['calc_second_order'], 
                       print_to_console=True)
    Si_df = Si.to_df()
    fig, axes = plt.subplots(1, len(Si_df))
    for idx, f in enumerate(Si_df):
        axes[idx] = barplot(f, ax=axes[idx])
    fig.suptitle('ra '+'sensitivity')

else:
    Si = morris.analyze(salib_pb, inputs, output, print_to_console=True)

    fig, (ax1, ax2) = plt.subplots(1,2)
    fig.suptitle('ra '+'sensitivity')

    mp.horizontal_bar_plot(ax1, Si, {})
    mp.covariance_plot(ax2, Si, {})

print('')
print('*** Output: rp')
output = data['outputs']['rp'].reshape((-1,))

if options.sobol:  
    Si = sobol.analyze(salib_pb, output, 
                       calc_second_order=sa_doe_options['calc_second_order'], 
                       print_to_console=True)
    Si_df = Si.to_df()
    fig, axes = plt.subplots(1, len(Si_df))
    for idx, f in enumerate(Si_df):
        axes[idx] = barplot(f, ax=axes[idx])
    fig.suptitle('rp '+'sensitivity')

else:
    Si = morris.analyze(salib_pb, inputs, output, print_to_console=True)

    fig, (ax1, ax2) = plt.subplots(1,2)
    fig.suptitle('rp '+'sensitivity')

    mp.horizontal_bar_plot(ax1, Si, {})
    mp.covariance_plot(ax2, Si, {})

print('')
print('*** Output: V2')
output = data['outputs']['V2'].reshape((-1,))

if options.sobol:  
    Si = sobol.analyze(salib_pb, output, 
                       calc_second_order=sa_doe_options['calc_second_order'], 
                       print_to_console=True)
    Si_df = Si.to_df()
    fig, axes = plt.subplots(1, len(Si_df))
    for idx, f in enumerate(Si_df):
        axes[idx] = barplot(f, ax=axes[idx])
    fig.suptitle('V2 '+'sensitivity')

else:
    Si = morris.analyze(salib_pb, inputs, output, print_to_console=True)

    fig, (ax1, ax2) = plt.subplots(1,2)
    fig.suptitle('V2 '+'sensitivity')

    mp.horizontal_bar_plot(ax1, Si, {})
    mp.covariance_plot(ax2, Si, {})

  
plt.show()

